<script type="module">
   import {init as scrollable, eventScrolled} from '/scrollable.js';
   import {handler} from '/scrollloader.js';
   import {init as dataloader, eventStarted, eventStopped} from '/dataloader.js';
   import {init as modifyurls} from '/modifyurls.js';
   import {dataListener, dataqueryclick, dataObserver} from '/system.js';

   //TODO move into file
   function clickBtn(name, apiName, sourceName) {
      return e => {
         // console.log(tabsId, tab, apiName, sourceName, e.detail)
         if ([e.detail.targetName, e.detail.apiName].includes(apiName)) {
            if (!sourceName || sourceName === e.detail.srcElement?.getAttribute('data-loader')) {
               const btn = document.querySelector('button[name=' + name + ']')
               // console.log(btn)
               btn.click()
            }
         }
      }
   }


   document.addEventListener('DOMContentLoaded', () => {
      const spinner = document.getElementById('spinner-overlay')
      scrollable()
      dataloader()
      dataListener(document)
      // dataclickListener(document)
      dataqueryclick(document)
      dataObserver(document.body)
      spinner.classList.add('g-dn')
      eventScrolled(handler())
      eventScrolled(e => console.log(e.detail))
      eventStopped(e => console.log(e.detail))
      eventStopped(e => {
         if(e.detail.apiName==='memos_search' || e.detail.apiName==='files_search' ){
            scrollable()
         }
      })
      eventStopped(modifyurls('parts', 'partview', 'content_type'))
      eventStopped(modifyurls('memos_menu', 'memos', 'memos_menu'))
      eventStopped(modifyurls('memo', 'memo', 'editor'))
      eventStopped(clickBtn('memo-tab', 'memo', 'memos files memo insert files_search'))
      eventStopped(clickBtn('memo-tab', 'memo', 'memo'))
      eventStopped(clickBtn('memos-tab', 'memo_delete'))
      eventStopped(clickBtn('memos-tab', 'memo_restore'))
      eventStopped(clickBtn('insert-tab', 'memo_edit'))
      eventStopped(clickBtn('memos-tab', 'versions'))
      eventStopped(clickBtn('memos-tab', 'memos'))
      eventStopped(e => {
         if ([e.detail.targetName, e.detail.apiName].includes('insert_editor')) {
            // console.log('script', e.detail.targetElement)
            // dataclickListener(e.detail.targetElement)
            dataListener(e.detail.targetElement)
         }
      })
      eventStopped(e => {
         // console.log('script', e.detail.apiName)
         if (e.detail.apiName === 'insert_container_modebtn_first') {
            // console.log('script', e.detail)
            // dataclickListener(e.detail.targetElement)
            dataListener(e.detail.targetElement)
            dataqueryclick(e.detail.targetElement)
         }
      })
      eventStopped(e => {
         if (e.detail.apiName === 'memo_edit' && e.detail.targetName === 'insert_container') {
            // dataclickListener(e.detail.targetElement)
            dataListener(e.detail.targetElement)
            dataqueryclick(e.detail.targetElement)
         }
      })
      let spinnertimer;
      eventStarted(e => {
         if (spinnertimer) clearTimeout(spinnertimer)
         spinnertimer = setTimeout(i => spinner.classList.remove('g-dn'), 10)
      })
      eventStopped(e => {
         if (spinnertimer) clearTimeout(spinnertimer)
         spinner.classList.add('g-dn')
      })
   })

   window.addEventListener('popstate', () => {
      window.location.reload();
   })
</script>
